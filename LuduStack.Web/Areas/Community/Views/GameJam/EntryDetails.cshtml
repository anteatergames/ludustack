@model GameJamEntryViewModel
@{
    ViewData["Title"] = Model.Title;
    if (Model.Game != null)
    {
        ViewData["Description"] = Model.Game.Description;
    }
    ViewData["Url"] = ViewBag.BaseUrl + Url.Action("entry", "gamejam", new { area = "community", id = Model.Id, jamHandler = Model.GameJam.Handler });
    ViewData["OgImage"] = Model.FeaturedImage;

    if (!string.IsNullOrWhiteSpace(Model.GameJam.BackgroundImage))
    {
        ViewData["BackgroundImage"] = Model.GameJam.BackgroundImage;
    }

    var showAds = (bool)(ViewBag.ShowAds ?? false);

    var authorUrl = Url.Action("details", "profile", new { area = string.Empty, userHandler = Model.UserHandler });
    var authorLink = string.Format("<a href=\"{0}\" class=\"boldlink text-nowrap\">{1}</a>", authorUrl, Model.AuthorName);

    var gameJamUrl = Url.Action("details", "gamejam", new { area = "community", handler = Model.GameJam.Handler });
    var gameJamLink = string.Format("<a href=\"{0}\" class=\"boldlink text-nowrap\">{1}</a>", gameJamUrl, Model.GameJam.Name);


    List<SelectListItem> userGames = new List<SelectListItem>();
    if (Model.Game == null)
    {
        userGames = ViewBag.UserGames as List<SelectListItem>;
    }

    var currentUserId = ViewBag.CurrentUserId ?? Guid.Empty;
}

@section Styles {
    <environment include="Development">
        <link rel="stylesheet" href="~/lib/bootstrap-star-rating/css/star-rating.css">
        <link rel="stylesheet" href="~/lib/bootstrap-star-rating/themes/krajee-fa/theme.css" media="all" type="text/css" />
        <link rel="stylesheet" href="~/css/gamejamdetails.css" />
    </environment>
    <environment exclude="Development">
        <link rel="stylesheet" href="~/lib/bootstrap-star-rating/css/star-rating.min.css">
        <link rel="stylesheet" href="~/lib/bootstrap-star-rating/themes/krajee-fas/theme.min.css" media="all" type="text/css" />
        <link rel="stylesheet" href="~/css/gamejamdetails.min.css" asp-append-version="true" />
    </environment>
}

@section Scripts {

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <environment include="Development">
        <script src="~/lib/bootstrap-star-rating/js/star-rating.js"></script>
        <script src="~/lib/bootstrap-star-rating/themes/krajee-fas/theme.js"></script>
        <script src="~/js/shared/fx.js"></script>
        <script src="~/js/gamejam/gamejamentrydetails.js"></script>
    </environment>
    <environment exclude="Development">
        <script src="~/lib/bootstrap-star-rating/js/star-rating.min.js"></script>
        <script src="~/lib/bootstrap-star-rating/themes/krajee-fa/theme.min.js"></script>
        <script src="~/js/shared/fx.js"></script>
        <script src="~/js/gamejam/gamejamentrydetails.min.js" asp-append-version="true"></script>
    </environment>
}

<section class="content container">
    <div id="featurecontainer" class="htmlcontent">
        <input asp-for="SecondsToCountDown" type="hidden" />

        @if (!string.IsNullOrWhiteSpace(Model.GameJam.BannerImage))
        {
            <div class="row mb-3 ">
                <div class="col-12 col-md-6 text-center">
                    <a href="@Url.Action("details", "gamejam", new { area = "community", handler = Model.GameJam.Handler })">
                        <img src="@Model.GameJam.BannerImage" class="img-fluid rounded jambanner" alt="@Model.GameJam.Name" />
                    </a>
                </div>
                <div class="col-12 col-md-6 d-flex flex-row justify-content-center">
                    <div class=" d-flex flex-column justify-content-center">
                        <div class="p-3 row justify-content-center bg-white bordered">
                            <partial name="_GameJamCounter" model="@new KeyValuePair<GameJamPhase, string>(Model.GameJam.CurrentPhase, Model.GameJam.CountDownMessage)" />
                        </div>
                        <div class="d-flex flex-row justify-content-center mt-n3">
                            <div class="bg-white">
                                <a asp-area="community" asp-controller="gamejam" asp-action="details" asp-route-handler="@Model.GameJam.Handler" asp-fragment="tabsubmissions" class="btn btn-lg btn-success btn-join text-uppercase">@SharedLocalizer["see other entries"]</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="box bg-light">
            <div class="row mx-2">
                <div class="mb-2 mr-2 d-flex flex-column justify-content-center">
                    <a asp-area="" asp-controller="profile" asp-action="details" asp-route-userHandler="@Model.UserHandler">
                        <img class="rounded-circle" src="@Model.AuthorPicture" alt="This is @Model.AuthorName">
                    </a>
                </div>
                <div class="mr-auto mb-2 d-flex flex-column justify-content-center">
                    <h1 class="m-0 text-capitalize">@Model.Title</h1>
                    @if (Model.Submitted)
                    {
                        <span class="text-left text-muted">@Html.Raw(SharedLocalizer["Submitted by {0} for {1}", authorLink, gameJamLink])</span>
                    }
                    else
                    {
                        <span class="text-left text-muted">@Html.Raw(SharedLocalizer["For {1}", authorLink, gameJamLink])</span>
                    }
                </div>
                <div class="ml-auto mb-2 d-flex flex-column justify-content-center">
                    @if (Model.Submitted)
                    {
                        <span class="h3 text-center">@Model.SubmissionDate</span>
                    }
                    else
                    {
                        <span class="h3 text-center">@SharedLocalizer["Not submitted yet"]</span>
                    }
                    <span class="text-right text-muted">@SharedLocalizer["submission date"]</span>
                </div>
            </div>

            @if (Model.Game != null)
            {
                <div class="bg-white mx-auto p-3 row">

                    <div class="col-12 pt-2">
                        <div class="row">
                            <div class="col-12 col-md-4 mb-2">
                                <partial name="_GameInfoPanel" model="Model.Game" />
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="row">
                                    <div class="col-12 text-uppercase mb-3">
                                        <a href="@Url.Action("details", "game", new { area = string.Empty, id = Model.Game.Id })" class="btn btn-large btn-block btn-secondary">
                                            @SharedLocalizer["visit game page"]
                                        </a>
                                    </div>
                                    <div class="col-12">
                                        @Html.Raw(Model.Game.Description)
                                    </div>

                                    <div class="col-12">
                                        <hr />
                                    </div>
                                    <div class="col-12 mb-2">
                                        @if (Model.Permissions.CanVote)
                                        {
                                            <h2>@SharedLocalizer["Vote"]</h2>
                                        }
                                        else
                                        {
                                            <h2>@SharedLocalizer["Score"]</h2>
                                        }

                                        @foreach (var criteria in Model.GameJam.Criteria)
                                        {
                                            var vote = Model.Votes.FirstOrDefault(x => x.UserId == currentUserId && x.CriteriaType == criteria.Type);

                                            <div class="row no-gutters">
                                                <div class="col-12 col-lg-6">
                                                    <div class="d-flex flex-column justify-content-center text-center">
                                                        <span class="display-4">@criteria.Name</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-lg-6">
                                                    <div class="h-100 d-flex flex-column justify-content-center text-center">

                                                        @if (Model.Permissions.CanVote)
                                                        {
                                                            <input id="txtScore" name="Score" type="number" class="d-none criteria-rating" step="1" value="@vote.Score.ToString(new System.Globalization.CultureInfo("en-US"))" data-url="@Url.Action("voteentry", "gamejam", new { area = "community", jamHandler = Model.GameJam.Handler, userId = ViewBag.CurrentUserId, entryId = Model.Id, criteriaType = vote.CriteriaType })">
                                                        }
                                                        else
                                                        {
                                                            <input id="txtScore" name="Score" type="number" class="d-none criteria-rating" step="1" data-readonly="true" value="@vote.Median.ToString(new System.Globalization.CultureInfo("en-US"))">
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                var noSubmissionModel = new ListNoItemsViewModel("fas fa-dizzy", "This Entry was not submitted yet!");
                <partial name="_ListNoItems" model="noSubmissionModel" />
            }

            @if (Model.Game == null && userGames != null && userGames.Any() && Model.Permissions.CanSubmit)
            {
                var createGameUrl = Url.Action("add", "game", new { area = string.Empty });
                var createGameLink = string.Format("<a href=\"{0}\" class=\"boldlink text-nowrap\">{1}</a>", createGameUrl, SharedLocalizer["click here"].Value);

                <form id="frmSubmitGame" asp-area="community" asp-controller="gamejam" asp-action="submitgame" asp-route-jamHandler="@Model.GameJam.Handler" method="post" class="mt-2">
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-heading alert-warning text-center">
                                <span class="d-block">@SharedLocalizer["This is your entry for this Game Jam. Start working on your game and submit it on this page when it is ready."]</span>
                                <span class="d-block">@Html.Raw(SharedLocalizer["If your game is not listed below, {0} to create a new game on the LuduStack platform.", createGameLink])</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <h2 class="m-0 text-capitalize">@SharedLocalizer["Submit your game"]</h2>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <select asp-for="GameId" asp-items="@userGames" class="form-control select2">
                                    <option selected="selected" value="">@SharedLocalizer["Select the game to submit"]</option>
                                </select>
                                <span asp-validation-for="GameId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="col-12 col-lg-6 offset-lg-6 col-xl-4 offset-xl-8 mt-1 mb-2">
                            <button type="button" id="btnSubmitGame" class="btn btn-lg btn-primary btn-block"><i class="fas fa-save" aria-hidden="true"></i> @SharedLocalizer["Submit"]</button>
                        </div>
                    </div>
                </form>
            }
        </div>
    </div>
</section>